define(["jquery","underscore","backbone","text!models/query/options.js","models/overlay/overlay","models/overlay/nls/lexicon"],function(e,t,n,r,i,s){var o=[{id:"patent",name:"Patent",isActive:!0,defaults:["patent_title"],url:"/querytool/query/fields.html#patent"},{id:"inventor",name:"Inventor",isActive:!1,defaults:["inventor_id","inventor_first_name","inventor_last_name"],url:"/querytool/query/fields.html#inventor"},{id:"assignee",name:"Assignee",isActive:!1,defaults:["assignee_id","assignee_first_name","assignee_last_name","assignee_organization"],url:"/querytool/query/fields.html#assignee"}],u=[{ops:[{key:"_eq",value:"equals"},{key:"_neq",value:"not equal"},{key:"_begins",value:"begins with"},{key:"_contains",value:"contains"}],type:"string",matches:["string"]},{ops:[{key:"_eq",value:"equals"}],type:"select",matches:["select"]},{ops:[{key:"_text_any",value:"any"},{key:"_text_all",value:"all"},{key:"_text_phrase",value:"phrase"}],type:"string",matches:["full text"]},{ops:[{key:"_eq",value:"equals"},{key:"_neq",value:"not equal"}],type:"boolean",matches:["boolean"]},{ops:[{key:"_eq",value:"equals"},{key:"_neq",value:"not equal"},{key:"_gt",value:"greater"},{key:"_gte",value:"greater or equal"},{key:"_lt",value:"less"},{key:"_lte",value:"less or equal"}],type:"date",matches:["date"],validation:{format:"YYYY-MM-DD"},placeholder:"YYYY-MM-DD"},{ops:[{key:"_eq",value:"equals"},{key:"_neq",value:"not equal"},{key:"_gt",value:"greater"},{key:"_gte",value:"greater or equal"},{key:"_lt",value:"less"},{key:"_lte",value:"less or equal"}],type:"time",matches:["time"]},{ops:[{key:"_eq",value:"equals"},{key:"_neq",value:"not equal"},{key:"_gt",value:"greater"},{key:"_gte",value:"greater or equal"},{key:"_lt",value:"less"},{key:"_lte",value:"less or equal"}],type:"datetime",matches:["datetime"]},{ops:[{key:"_eq",value:"equals"},{key:"_neq",value:"not equal"},{key:"_gt",value:"greater"},{key:"_gte",value:"greater or equal"},{key:"_lt",value:"less"},{key:"_lte",value:"less or equal"}],type:"integer",matches:["integer"]},{ops:[{key:"_eq",value:"equals"},{key:"_neq",value:"not equal"},{key:"_gt",value:"greater"},{key:"_gte",value:"greater or equal"},{key:"_lt",value:"less"},{key:"_lte",value:"less or equal"}],type:"double",matches:["double","float"]}],a=[{type:"text",matches:["input"]},{type:"select",matches:["select","boolean"]}],f=[{category:"Patent",categoryId:"Patent",shortName:"Patent",shortNameId:"Patent",name:"applications",desc:"Data on patents and applications associated with patents"},{category:"Assignee",categoryId:"Assignee",shortName:"Assignee",shortNameId:"Assignee",name:"assignees",desc:"Data on assignees on the patents"},{category:"Inventor",categoryId:"Inventor",shortName:"Inventor",shortNameId:"Inventor",name:"inventors",desc:"Data on the inventors on the patents"},{category:"Citations",categoryId:"Citations",shortName:"Cited Appliations",shortNameId:"Cited_Appliations",name:"application_citations",desc:"Data on applications that are cited by patents"},{category:"Citations",categoryId:"Citations",shortName:"Citing Patents",shortNameId:"Citing_Patents",name:"citedby_patents",desc:"Data on patents that have cited the patents"},{category:"Citations",categoryId:"Citations",shortName:"Cited Patents",shortNameId:"Cited_Patents",name:"cited_patents",desc:"Data on patents that have been cited by the patents"},{category:"Technology Classifications",categoryId:"Technology_Classifications",shortName:"CPC",shortNameId:"CPC",name:"cpcs",desc:"Metadata describing the cooperative patent classification of the patents"},{category:"Technology Classifications",categoryId:"Technology_Classifications",shortName:"IPC",shortNameId:"IPC",name:"ipcs",desc:"Metadata describing the international patent classification of the patents"},{category:"Technology Classifications",categoryId:"Technology_Classifications",shortName:"NBER",shortNameId:"NBER",name:"nbers",desc:"Metadata describing the technology area of the patents.  See www.nber.org/patents for more information on NBER technology areas."},{category:"Technology Classifications",categoryId:"Technology_Classifications",shortName:"USPC",shortNameId:"USPC",name:"uspcs",desc:"Metadata describing the US patent classification of the patents"}],l=[{className:"center-pane",blockMouse:!1,verticalCenter:!1,items:[{className:"center-pane",key:i.overlays.patentClass,file:"patentClass.html",title:s.root.titles.patentClass},{className:"center-pane scroll",key:i.overlays.uspc,file:"uspc.html",title:s.root.titles.uspc},{className:"center-pane scroll",key:i.overlays.nber,file:"nber.html",title:s.root.titles.nber},{className:"center-pane scroll",key:i.overlays.cpc,file:"cpc.html",title:s.root.titles.cpc}]}],c=JSON.parse(r);for(var h=0;h<o.length;h++)o[h].outputs=new Array,t.where(c,{entities:[o[h].id]}).forEach(function(e){if(e.isOutput){var n=t.contains(o[h].defaults,e.id),r=t.find(o[h].outputs,{id:e.group}),i={id:e.id,name:e.name,desc:e.desc,isActive:n};if(t.isUndefined(r)){var s=t.find(f,{name:e.group});t.isUndefined(s)?r={id:e.group,name:e.group,category:"",shortName:"",isActive:n,desc:"",fields:new Array}:r={id:e.group,name:e.group,category:s.category,shortName:s.shortName,isActive:n,desc:s.desc,fields:new Array},r.fields.push(i),o[h].outputs.push(r)}else r.fields.push(i)}});var p=n.Model.extend({initialize:function(){this.set("options",c),this.set("entities",o),this.set("isQuickSearch",!1),this.set("quickSearch",""),this.set("query",{}),this.set("expressions",[]),this.set("outputs",[]),this.set("sorts",[]),this.set("entityId","patent"),this.set("outputIds",[]),this.set("groupId",""),this.set("fieldId",""),this.set("resultCount","0"),this.set("recipient",""),this.set("xml",""),this.set("json",""),this.set("csv","")},getFilters:function(e){var n=this.get("entityId"),r=new Array;return t.where(this.get("options"),{entities:[n]}).forEach(function(n){if(!t.isNull(e)&&!t.isEmpty(e)&&n.group!=e)return;var i=t.find(u,{matches:[n.values.length>0?"select":n.type]}),s=t.find(a,{matches:[n.fieldType]});if(n.isQuery==="true"){var o={id:n.id,label:n.name,type:i.type,input:s.type,operators:i.ops,values:n.values,remoteUrl:n.remoteUrl,optgroup:n.group,desc:n.desc};t.isUndefined(i.validation)||(o.validation=i.validation),t.isUndefined(i.placeholder)||(o.placeholder=i.placeholder),r.push(o)}}),r},getFilter:function(e){var n=this.get("entityId"),r={},i=t.find(this.get("options"),{entities:[n],id:e});if(!t.isUndefined(i)){var s=t.find(u,{matches:[i.values.length>0?"select":i.type]}),o=t.find(a,{matches:[i.fieldType]});r={id:i.id,label:i.name,type:s.type,input:o.type,operators:s.ops,values:i.values,remoteUrl:i.remoteUrl,optgroup:i.group,desc:i.desc},t.isUndefined(s.validation)||(r.validation=s.validation),t.isUndefined(s.placeholder)||(r.placeholder=s.placeholder)}return r},getGroups:function(){var e=this.get("entityId"),n=new Array;if(t.isNull(e)||t.isEmpty(e)){this.set("groups",n);return}return t.where(this.get("options"),{entities:[e]}).forEach(function(e){n.push({id:e.group,name:e.group,isActive:!1})}),t.uniq(n,"id")},getFields:function(e){var n=this.get("entityId"),r=new Array;return t.isNull(e)||t.isEmpty(e)?r:(t.where(this.get("options"),{entities:[n],group:e}).forEach(function(e){e.isQuery&&r.push({id:e.id,name:e.name,isActive:!1})}),r)},getConditions:function(e){var n=this.get("entityId"),r=new Array;if(t.isNull(e)||t.isEmpty(e))return r;var i=t.findWhere(this.get("options"),{entities:[n],id:e});if(!t.isUndefined(i)){var s=i.type;t.where(this.get("operators"),{types:[s]}).forEach(function(e){r.push({id:e.id,name:e.name,isActive:!1})})}return r},getOutputs:function(e){var n=this.get("entityId"),r=this.get("outputIds"),i=new Array,s=t.find(o,{id:n});return t.isNull(n)||t.isEmpty(n)?(this.set("groups",i),i):(t.where(this.get("options"),{entities:[n]}).forEach(function(n){if(e&&!t.contains(r,n.id))return!0;if(n.isOutput){var o=t.contains(s.defaults,n.id)||t.contains(r,n.id),u={id:n.id,name:n.name,desc:n.desc,isActive:o},a=t.find(f,{name:n.group}),l=null;if(a.category!=a.shortName){l=t.find(i,{shortName:a.category});var c=!1;t.isUndefined(l)&&(c=!0,l={id:a.categoryId,name:a.category,categoryId:a.categoryId,shortName:a.category,shortNameId:a.shortNameId,isActive:o,desc:"",groups:new Array}),subGroup=t.find(l.groups,{shortName:a.shortName}),t.isUndefined(subGroup)?(subGroup={id:n.group,name:n.group,categoryId:a.categoryId,shortName:a.shortName,shortNameId:a.shortNameId,isActive:o,desc:t.isUndefined(a)?"":a.desc,fields:new Array},subGroup.fields.push(u),l.groups.push(subGroup)):subGroup.fields.push(u),c&&i.push(l)}else l=t.find(i,{id:n.group}),t.isUndefined(l)?(l={id:n.group,name:n.group,categoryId:a.categoryId,shortName:a.shortName,shortNameId:a.shortNameId,isActive:o,desc:t.isUndefined(a)?"":a.desc,fields:new Array},l.fields.push(u),i.push(l)):(t.isUndefined(l.fields)&&(l.fields=new Array),l.fields.push(u))}}),i)},getSorts:function(){var e=this.get("entityId"),n=new Array;return t.isNull(e)||t.isEmpty(e)?(this.set("groups",n),n):(t.where(this.get("options"),{entities:[e]}).forEach(function(e){if(e.isSort){var r=t.find(n,{id:e.group}),i={id:e.id,name:e.name,isActive:!1};if(t.isUndefined(r)){var s=t.find(f,{name:e.group});r={id:e.group,name:s.shortName,isActive:!1,fields:new Array},r.fields.push(i),n.push(r)}else r.fields.push(i)}}),n)},getOverlay:function(e){return t.find(l,function(n){return!!t.findWhere(n.items,{key:e})})},setGroups:function(){this.set("groups",this.getGroups())},buildQuery:function(){var e=this.get("quickSearch"),t=this.get("expressions"),n="",r="]}";if(this.get("isQuickSearch")){if(e.length==0)return n;var i=e.split(" ");n='{"_and":[';for(var s=0;s<i.length;s++)n=n+'{"_or":[{"patent_title":"'+i[s]+'"},{"patent_abstract":"'+i[s]+'"},{"assignee_organization":"'+i[s]+'"},{"assignee_first_name":"'+i[s]+'"},{"assignee_last_name":"'+i[s]+'"},{"inventor_first_name":"'+i[s]+'"},{"inventor_last_name":"'+i[s]+'"}]},'}else{if(t.length==0)return n;if(t.length==1)t[0].operator=="_eq"?n=n+'{"'+t[0].field+'":"'+t[0].value+'"},':n=n+'{"'+t[0].operator+'":{"'+t[0].field+'":"'+t[0].value+'"}},',r="";else{n='{"_and":[';for(var s=0;s<t.length;s++)t[s].operator=="_eq"?n=n+'{"'+t[s].field+'":"'+t[s].value+'"},':n=n+'{"'+t[s].operator+'":{"'+t[s].field+'":"'+t[s].value+'"}},'}}n=n.replace(/,\s*$/,"")+r;var o=this.get("fieldId");o=o==""?"patent_title":o;var u="";u="q="+n+"&f="+JSON.stringify(this.get("outputIds"))+'&s=[{"'+o+'":"asc"}]';return u}});return p});