define(["jquery","underscore","backbone","handlebars","text!views/query/templates/SelectResults.html","text!views/query/templates/OutputListsPatent.html","text!views/query/templates/OutputListsAssignee.html","text!views/query/templates/OutputListsInventor.html","text!views/query/templates/OutputLists.html","bootstrap","validate"],function(e,t,n,r,i,s,o,u,a){var f=n.View.extend({tagName:"section",className:"step-view",id:"selectResults",initialize:function(e){this.listenTo(this.model,"entityChanged",this.entityChanged),t.bindAll(this,"render","updateModel"),this.template=r.compile(i),this.outputListPatent=r.compile(s),this.outputListAssignee=r.compile(o),this.outputListInventor=r.compile(u),this.outputList=r.compile(a),this.resetView=!0},events:{"click .list-group-item":"listGroupItemClick","change .category":"changeCategory","change .output":"changeOutput","change #group":"changeGroup"},render:function(n){if(n==1&&this.resetView==1){e(this.el).empty(),e(this.el).append(this.template(this.model.toJSON())),this.renderOutputs();var i=this.model.get("entityId"),s=this.model.get("groupId");if(!t.isEmpty(i)){var o=r.compile('"<option>- Select Group -</option>{{#each this}}{{#if isActive}}<option id="{{id}}" data-id="{{id}}" value="{{id}}" selected="selected">{{name}}</option>{{else}}<option id="{{id}}" data-id="{{id}}" value="{{id}}">{{name}}</option>{{/if}}{{/each}}"');e("#group").html(o(this.model.get("sorts")));var u=t.find(this.model.get("sorts"),{id:s});if(!t.isUndefined(u)){var a=r.compile('"<option>- Select Field -</option>{{#each this}}{{#if isActive}}<option id="{{id}}" data-id="{{id}}" value="{{id}}" selected="selected">{{name}}</option>{{else}}<option id="{{id}}" data-id="{{id}}" value="{{id}}">{{name}}</option>{{/if}}{{/each}}"');e("#field").html(a(u.fields))}}this.resetView=!1}return this},entityChanged:function(e){this.resetView=!0},changeCategory:function(t){t=t||window.event;var n=e(t.srcElement||t.target),r=n[0].checked,i=e(n).closest(".list-group");i.find(".output").prop("checked",r),i.find(".category").prop("checked",r),r&&(e(n).closest(".list-group-item").toggleClass("collapsed"),e(i.find(".list-group-item").data("target")).collapse("show"))},changeOutput:function(t){t=t||window.event;var n=e(t.srcElement||t.target);e(n).closest(".list-group-submenu").find(".output").length>e(n).closest(".list-group-submenu").find(".output:checked").length?e(n).closest(".list-group").find(".category").prop("checked",!1):e(n).closest(".list-group").find(".category").prop("checked",!0)},listGroupItemClick:function(t){t=t||window.event;var n=e(t.srcElement||t.target);e(n).hasClass("list-group-item")&&(e(n).toggleClass("collapsed"),e(e(n).data("target")).collapse("toggle"))},changeGroup:function(n){n=n||window.event;var i=e(n.srcElement||n.target),s=i.find("option:selected").attr("data-id"),o=t.find(this.model.get("sorts"),{id:s});if(!t.isUndefined(o)){var u=r.compile('"<option>-Select Field-</option>{{#each this}}{{#if isActive}}<option id="{{id}}" data-id="{{id}}" selected="selected">{{name}}</option>{{else}}<option id="{{id}}" data-id="{{id}}" >{{name}}</option>{{/if}}{{/each}}"');e("#field").html(u(o.fields))}},isValid:function(){var t=e(this.el).find("#results-form");return t.validate({rules:{recipient:{required:!0,email:!0},format:{required:!0}},messages:{recipient:{required:"Please provide a valid e-mail address to send query results to."},format:{required:"Please select at least one format for the qurey."}},highlight:function(t){e(t).closest(".form-group").addClass("has-error")},unhighlight:function(t){e(t).closest(".form-group").removeClass("has-error")},errorPlacement:function(t,n){n.attr("name")==="format"?t.insertAfter(e(n).closest(".checkbox-group")):t.insertAfter(n)}}),t.valid()},updateModel:function(){var n=[],r=e(this.el).find(".output:checked").each(function(t,r){n.push(e(r).val())}),i=e(this.el).find("#group > option:selected"),s=e(this.el).find("#field > option:selected");this.model.set("outputIds",n),this.model.set("group",t.isUndefined(i.data("id"))?"None Selected":i.text()),this.model.set("field",t.isUndefined(s.data("id"))?"None Selected":s.text()),this.model.set("groupId",t.isUndefined(i.data("id"))?"":i.data("id")),this.model.set("fieldId",t.isUndefined(s.data("id"))?"":s.data("id")),this.model.set("recipient",e(this.el).find("#recipient").val()),this.model.set("xml",e(this.el).find("#xml").prop("checked")),this.model.set("csv",e(this.el).find("#csv").prop("checked")),this.model.set("json",e(this.el).find("#json").prop("checked"))},renderOutputs:function(){var n=this.model.get("entityId"),r=this.model.getOutputs(),i=this.outputList(t.find(r,{categoryId:"Patent"})),s=this.outputList(t.find(r,{categoryId:"Inventor"})),o=this.outputList(t.find(r,{categoryId:"Assignee"})),u=this.outputList(t.find(r,{categoryId:"Citations"})),a=this.outputList(t.find(r,{categoryId:"Technology_Classifications"}));switch(n){case"inventor":e(this.el).find("#outputs").html(this.outputListInventor({})),e(this.el).find("#patent-outputs").html(i),e(this.el).find("#inventor-outputs").html(s),e(this.el).find("#assignee-outputs").html(o),e(this.el).find("#technology_Classifications-outputs").html(a);break;case"assignee":e(this.el).find("#outputs").html(this.outputListAssignee({})),e(this.el).find("#patent-outputs").html(i),e(this.el).find("#inventor-outputs").html(s),e(this.el).find("#assignee-outputs").html(o),e(this.el).find("#technology_Classifications-outputs").html(a);break;default:e(this.el).find("#outputs").html(this.outputListPatent({})),e(this.el).find("#patent-outputs").html(i),e(this.el).find("#inventor-outputs").html(s),e(this.el).find("#assignee-outputs").html(o),e(this.el).find("#citations-outputs").html(u),e(this.el).find("#technology_Classifications-outputs").html(a)}},getNavHtml:function(e){return""},getNextHtml:function(){return'Review Query <i class="fa fa-caret-right" />'}});return f});