define(["jquery","underscore","backbone","vkbeautify","xml2json","prism","handlebars","text!views/query/templates/PreviewResults.html","text!views/query/templates/CSVTemplate.html","text!views/query/templates/SelectResults.html"],function(e,t,n,r,i,s,o,u,a,f){var l=n.View.extend({tagName:"section",id:"previewResults",className:"step-view",initialize:function(e){return this.listenTo(this.model,"entityChanged",this.entityChanged),t.bindAll(this,"render","updateModel"),this.template=o.compile(u),this.csv=o.compile(a),this.x2js=new i,this},events:{"change #group":"changeGroup"},render:function(){var n="Loading a preview of your query. This could take a couple of minutes, as we are searching through over 5 million patents.",r='<div class="sub-title" style="margin-top: 10px;">No Results.</div>',i=this.model.buildQuery(),u=this.model.get("entityId");this.model.set("query",i),e(this.el).empty(),e(this.el).append(this.template(this.model.toJSON())),e(this.el).find("#preview-csv").html(n),e(this.el).find("#preview-json").html(n),e(this.el).find("#preview-xml").html(n),i!=""&&(e.ajax({context:this,url:"http://www.patentsview.org/preview_api/"+u+"s/query?"+i,dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Negotiate")},async:!0,success:function(t){t.count>0?(e(this.el).find("#preview-csv").addClass("preview-csv-scroll").html(this.csv(t[Object.keys(t)[0]])),e(this.el).find("#preview-json").html('<pre style="max-height: 30em;" class="language-*"><code class="language-json">'+s.highlight(JSON.stringify(t,null,"	"),s.languages.json)+"</code></pre>")):(e(this.el).find("#preview-csv").removeClass("preview-csv-scroll").html(r),e(this.el).find("#preview-json").html(r))},error:function(t,n,i){e(this.el).find("#preview-csv").removeClass("preview-csv-scroll").html(r),e(this.el).find("#preview-json").html(r)}}),e.ajax({context:this,type:"POST",url:"/query/tocsv.php",dataType:"json",data:{query:result},beforeSend:function(e){e.setRequestHeader("Authorization","Negotiate")},async:!0,success:function(e){},error:function(t,n,i){e(this.el).find("#preview-csv").removeClass("preview-csv-scroll").html(r),e(this.el).find("#preview-json").html(r)}}),e.ajax({context:this,url:"http://www.patentsview.org/preview_api/"+u+"s/query?"+i+"&format=xml",dataType:"text",beforeSend:function(e){e.setRequestHeader("Authorization","Negotiate")},async:!0,success:function(t){if(t.indexOf("<count>0")>=0){e(this.el).find("#preview-xml").html(r);return}try{e(this.el).find("#preview-xml").html('<pre style="max-height: 30em;" class="language-*"><code class="language-markup">'+s.highlight(window.vkbeautify.xml(t),s.languages.markup)+"</code></pre>")}catch(n){e(this.el).find("#preview-xml").html(r)}},error:function(t,n,i){e(this.el).find("#preview-xml").html(r)}}));var u=this.model.get("entityId"),a=this.model.get("groupId");if(!t.isEmpty(u)){var f=o.compile('"<option>- Select Group -</option>{{#each this}}{{#if isActive}}<option id="{{id}}" data-id="{{id}}" value="{{id}}" selected="selected">{{name}}</option>{{else}}<option id="{{id}}" data-id="{{id}}" value="{{id}}">{{name}}</option>{{/if}}{{/each}}"');e("#group").html(f(this.model.get("sorts")));var l=t.find(this.model.get("sorts"),{id:a});if(!t.isUndefined(l)){var c=o.compile('"<option>- Select Field -</option>{{#each this}}{{#if isActive}}<option id="{{id}}" data-id="{{id}}" value="{{id}}" selected="selected">{{name}}</option>{{else}}<option id="{{id}}" data-id="{{id}}" value="{{id}}">{{name}}</option>{{/if}}{{/each}}"');e("#field").html(c(l.fields))}}return this},isValid:function(){var t=e(this.el).find("#results-form");return t.validate({rules:{recipient:{required:!0,email:!0},format:{required:!0}},messages:{recipient:{required:"Please provide a valid e-mail address to send query results to."},format:{required:"Please select at least one format for the qurey."}},highlight:function(t){e(t).closest(".form-group").addClass("has-error")},unhighlight:function(t){e(t).closest(".form-group").removeClass("has-error")},errorPlacement:function(t,n){n.attr("name")==="format"?t.insertAfter(e(n).closest(".checkbox-group")):t.insertAfter(n)}}),t.valid()},updateModel:function(){var n=e(this.el).find("#group > option:selected"),r=e(this.el).find("#field > option:selected");this.model.set("group",t.isUndefined(n.data("id"))?"None Selected":n.text()),this.model.set("field",t.isUndefined(r.data("id"))?"None Selected":r.text()),this.model.set("groupId",t.isUndefined(n.data("id"))?"":n.data("id")),this.model.set("fieldId",t.isUndefined(r.data("id"))?"":r.data("id")),this.model.set("recipient",e(this.el).find("#recipient").val()),this.model.set("xml",e(this.el).find("#xml").prop("checked")),this.model.set("csv",e(this.el).find("#csv").prop("checked")),this.model.set("json",e(this.el).find("#json").prop("checked"))},getNavHtml:function(e){return""},entityChanged:function(e){this.resetView=!0},changeGroup:function(n){n=n||window.event;var r=e(n.srcElement||n.target),i=r.find("option:selected").attr("data-id"),s=t.find(this.model.get("sorts"),{id:i});if(!t.isUndefined(s)){var u=o.compile('"<option>-Select Field-</option>{{#each this}}{{#if isActive}}<option id="{{id}}" data-id="{{id}}" selected="selected">{{name}}</option>{{else}}<option id="{{id}}" data-id="{{id}}" >{{name}}</option>{{/if}}{{/each}}"');e("#field").html(u(s.fields))}},flatten:function(e,t,n){var r,i,s;t=t||[],n=n||{};for(r in e)i=e[r],s=t.concat([r]),i instanceof Object?this.flatten(i,s,n):n[s.join(".")]=i;return n},createHeaders:function(e){for(key in e)headerPos=key.split(".")}});return l});