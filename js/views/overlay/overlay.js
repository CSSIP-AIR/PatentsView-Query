define(["underscore","jquery","backbone","models/overlay/overlay","i18n!models/overlay/nls/lexicon","text!views/overlay/templates/overlay.html"],function(e,t,n,r,i,s){var o=n.View.extend({className:"overlay",events:{"click .paneNav li":"onNavClick","click .close":"onCloseClick","mouseenter .term":"mouseenterTerm","mouseleave .term":"mouseleaveTerm",click:"clickOverlay"},initialize:function(){e.bindAll(this,"onKeyChange","render","onExternalAnchorClick"),this.model.on("change:key",this.onKeyChange),this.model.on("change:group change:sub",this.render),this.$el=t(this.el),t("body").append(this.$el),t("a.overlay-link").click(this.onExternalAnchorClick)},render:function(){function n(){u&&o.$el.removeClass(u.overlayClassName)}function r(r){n(),r=e.template(r,i);var u=e.extend({},o.model.attributes,{copy:r}),f=e.template(s,u);o.$el.html(f),o.$el.addClass(a.overlayClassName),a.blockMouse!==o.$el.hasClass("block-mouse")&&o.$el.toggleClass("block-mouse"),a.verticalCenter!==o.$el.hasClass("vertical-center")&&o.$el.toggleClass("vertical-center"),o.$el.find(".term").each(function(){var e=t(this),n=e.attr("data-term"),r=i.glossary[n];r&&e.attr("longdesc",r.title+": "+r.text)}),o.model.get("show")&&o.show()}var o=this,u=this.model.previous("group"),a=this.model.attributes.group;a?t.get("/querytool/overlays/"+this.model.get("sub").file+"?1",r,"text"):n()},onExternalAnchorClick:function(e){var n=t(e.currentTarget).attr("data-key");return this.model.set("key",n),e.preventDefault(),!1},onNavClick:function(e){var n=t(e.currentTarget).attr("data-key");this.model.set("key",n)},onCloseClick:function(){this.close()},clickOverlay:function(e){t(e.target).closest(".pane").length===0&&this.close()},mouseenterTerm:function(e){var n=this,r=t(e.currentTarget),s=r.attr("data-term");if(s&&i.glossary[s]){var o=i.glossary[s],u="<h5>"+o.title+"</h5><p>"+o.text+"</p>",a=t("<div></div>").addClass("tooltip").html(u);this.$el.find(".pane").append(a);var f=r.position();a.css({left:f.left-a.outerWidth()+r.outerWidth()*.5+20,top:f.top-a.outerHeight()-5}),a.hide(),setTimeout(function(){n.$tip&&n.$tip.fadeIn(300)},300),this.$tip=a}return e.preventDefault(),!1},mouseleaveTerm:function(e){this.removeTip()},removeTip:function(){var e=this.$tip;this.$tip=null,e&&e.fadeOut(300,function(){e.remove()})},onKeyChange:function(t,n,r){var i=e.find(o.groups,function(t){return!!e.findWhere(t.items,{key:n})});i?this.model.set({group:i,sub:e.findWhere(i.items,{key:n}),show:!0}):(this.model.set({group:null,sub:null,show:!1}),this.hide())},close:function(){this.model.set("key",null)},show:function(){this.model.get("isVisible")||(this.model.set("isVisible",!0),this.$el.find(".pane").css({opacity:0,top:10}).animate({opacity:1,top:0},200),this.$el.show())},hide:function(){this.model.get("isVisible")&&(this.model.set("isVisible",!1),this.$el.fadeOut(200))},exposeApi:function(t){var n=this;t.overlaysApi={register:function(t){if(!(e.isObject(t)&&e.isArray(t.items)&&t.items.length>0))throw"Overlay group must be an object with an items array of length >= 1";for(var r=0,i=t.items.length;r<i;++r){var s=t.items[r];if(!(e.isString(s.key)&&s.key.length>0))throw'Each overlay group item must have a valid "key"';if(!n.keyIsAvailable_(s.key))throw'Overlay key "'+s.key+'" is already taken.';if(!(e.isString(s.file)&&s.file.length>0))throw'Each overlay group item must have a "file" name';if(s.title!==void 0&&!e.isString(s.title))throw'Each overlay group item "title" must be a string or undefined'}o.groups.push(t)},show:function(t){if(!e.isString(t))throw"Key must be a string";n.model.set("key",t)},hide:function(){n.model.set("key",null)}}},keyIsAvailable_:function(e){var t=o.groups;for(var n=0,r=t.length;n<r;++n){var i=t[n].items;for(var s=0,u=i.length;s<u;++s)if(i[s].key===e)return!1}return!0}},{groups:[{className:"center-pane",blockMouse:!0,verticalCenter:!1,items:[{key:r.overlays.about,file:"about.html",title:i.titles.about},{key:r.overlays.economist,file:"economist.html",title:i.titles.economist}]},{className:"center-pane",blockMouse:!0,verticalCenter:!1,items:[{key:r.overlays.methodsSources,file:"methodsSources.html",title:i.titles.methodsSources}]},{className:"center-pane",blockMouse:!0,verticalCenter:!1,items:[{className:"glossary scroll",key:r.overlays.glossary,file:"glossary.html",title:i.titles.glossary}]},{className:"center-pane",blockMouse:!1,verticalCenter:!1,items:[{className:"patent-class-overview",key:r.overlays.patentClass,file:"patentClass.html",title:i.titles.patentClass},{className:"patent-class-type scroll",key:r.overlays.uspc,file:"uspc.html",title:i.titles.uspc},{className:"patent-class-type scroll",key:r.overlays.nber,file:"nber.html",title:i.titles.nber},{className:"patent-class-type scroll",key:r.overlays.cpc,file:"cpc.html",title:i.titles.cpc}]},{className:"right-pane",blockMouse:!1,verticalCenter:!1,items:[{key:r.overlays.howTo,file:"howTo.html",title:i.titles.howTo},{className:"filter-opts",key:r.overlays.filterOpts,file:"filterOpts.html",title:i.titles.filterOpts}]}]});return o});