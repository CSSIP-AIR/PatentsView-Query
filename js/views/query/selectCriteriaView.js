define(["jquery","underscore","backbone","handlebars","text!views/query/templates/SelectCriteria.html","text!views/query/templates/SelectCriteriaPatent.html","text!views/query/templates/SelectCriteriaAssignee.html","text!views/query/templates/SelectCriteriaInventor.html","text!views/query/templates/Expressions.html","text!views/query/templates/AddCriteria.html","text!views/query/templates/AddCriteriaOperator.html","text!views/query/templates/AddCriteriaValue.html","bootstrap","models/overlay/overlay","views/overlay/overlay","validate","typeahead","bloodhound"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d=n.View.extend({tagName:"section",id:"selectCriteria",className:"step-view",initialize:function(e){return this.options=e,this.listenTo(this.model,"entityChanged",this.entityChanged),t.bindAll(this,"render","updateModel"),this.template=r.compile(i),this.selectCriteriaPatentTemplate=r.compile(s),this.selectCriteriaAssigneeTemplate=r.compile(o),this.selectCriteriaInventorTemplate=r.compile(u),this.expressionsTemplate=r.compile(a),this.addTemplate=r.compile(f),this.addOperatorTemplate=r.compile(l),this.addValueTemplate=r.compile(c),this},events:{"click #advanced-search":"toggleSearch","click #back-quick-search":"toggleSearch","click .quick-search":"quickSearch","click .submit-search":"submitSearch","keyup #quickSearch":"keyPressQuickSearch","click input[type=radio][name=entity]":"selectEntity","change #patent-condition":"changeCondition","change #assignee-condition":"changeCondition","change #inventor-condition":"changeCondition","change #lawyer-condition":"changeCondition","change #cpc-condition":"changeCondition","change #nber-condition":"changeCondition","change #ipc-condition":"changeCondition","change #uspc-condition":"changeCondition","change #wipos-condition":"changeCondition","change #citedPatents-condition":"changeCondition","change #citedApplications-condition":"changeCondition","change #citingPatents-condition":"changeCondition","click #add-applications":"addCondition","click #add-inventors":"addCondition","click #add-assignees":"addCondition","click #add-lawyers":"addCondition","click #add-cpcs":"addCondition","click #add-nbers":"addCondition","click #add-ipcs":"addCondition","click #add-uspcs":"addCondition","click #add-wipos":"addCondition","click #add-cited_patents":"addCondition","click #add-application_citations":"addCondition","click #add-citedby_patents":"addCondition","click .clear-btn":"clearCondition","click #filters-clearall":"clearAllExpressions","keydown .city":"keyLocation","keydown .state":"keyLocation","focusout .city":"blurLocation","focusout .state":"blurLocation","focusout .country":"blurLocation"},render:function(){var t=this.model.toJSON();return e(this.el).empty(),e(this.el).append(this.template(t)),this.renderCategoryCriteria(),e(this.el).find("#filters").html(this.expressionsTemplate(t)),this.model.get("isQuickSearch")?(e(this.el).find("#entity-section").hide(),e(this.el).find("#criteria-section").hide(),e(this.el).find("#quick-search-section").show(),e(this.el).find("#back-quick-search").hide(),e(this.el).find(".intro-text").show(),e(this.el).find(".intro").addClass("intro-centered")):(e(this.el).find("#quick-search-section").hide(),e(this.el).find("#entity-section").show(),e(this.el).find("#criteria-section").show(),e(this.el).find("#back-quick-search").show(),e(this.el).find(".intro-text").hide(),e(this.el).find(".intro").removeClass("intro-centered")),this},isValid:function(){if(this.model.get("isQuickSearch")==1){var t=e(this.el).find("#quickSearchForm");return t.validate({rules:{quickSearch:{required:!0}},messages:{quickSearch:{required:"Please provide quick search keywords for the query."}},highlight:function(t){e(t).closest("#quickSearch").addClass("has-error")},unhighlight:function(t){e(t).closest("#quickSearch").removeClass("has-error")}}),t.valid()}return e(this.el).find(".expression").length==0?(e(this.el).find("#filters").html('<span id="submitSearch-error" class="error">Please add search criteria for the query.</span>'),!1):!0},updateModel:function(){var n=this.model.get("entities"),r=e(this.el).find("input[name=entity]:checked"),i=r.data("name"),s=r.val(),o=t.find(n,{id:s}),u=[];e(this.el).find(".expression").each(function(t,n){var r=e(n);u.push({fieldText:r.data("fieldText"),field:r.data("field"),operatorText:r.data("operatorText"),operator:r.data("operator"),value:r.data("value")})}),t.forEach(n,function(e){e.isActive=e.id==s}),this.model.set("expressions",u),this.model.set("entities",n),this.model.set("entityId",s),this.model.set("entityName",i),this.model.set("quickSearch",e(this.el).find("#quickSearch").val()),this.model.set("sorts",this.model.getSorts())},renderCategoryCriteria:function(){var t=this.model.get("entityId"),n=this.addTemplate({optGroup:"applications",id:"applications",name:"Patents",tip:"Data related to patents and patent applications",fields:this.model.getFilters("applications")}),r=this.addTemplate({optGroup:"inventors",id:"inventors",name:"Inventors",tip:"Data related to inventors on the patents",fields:this.model.getFilters("inventors")}),i=this.addTemplate({optGroup:"assignees",id:"assignees",name:"Assignees",tip:"Data related to assignees on the patents",fields:this.model.getFilters("assignees")}),s=this.addTemplate({optGroup:"lawyers",id:"lawyers",name:"Lawyers",tip:"Data related to lawyers on the patents",fields:this.model.getFilters("lawyers")}),o=this.addTemplate({optGroup:"cpcs",id:"cpcs",name:"Cooperative Patent Class",tip:"Metadata describing the cooperative patent classification of the patents. The full class string can be searched in CPC Class field with type-ahead functionality.",fields:this.model.getFilters("cpcs")}),u=this.addTemplate({optGroup:"nbers",id:"nbers",name:"NBER",tip:"Metadata describing the technology area of the patents. See www.nber.org/patents for more information on NBER technology areas. Only available through May 2015.",fields:this.model.getFilters("nbers")}),a=this.addTemplate({optGroup:"ipcs",id:"ipcs",name:"International Patent Class",tip:"Metadata describing the international patent classification of the patents. The full class string can be searched in IPC Class field with type-ahead functionality.",fields:this.model.getFilters("ipcs")}),f=this.addTemplate({optGroup:"uspcs",id:"uspcs",name:"US Patent Class",tip:"Metadata describing the US patent classification of the patents. The full class string can be searched in USPC Class field with type-ahead functionality. Only available through May 2015.",fields:this.model.getFilters("uspcs")}),l=this.addTemplate({optGroup:"wipos",id:"wipos",name:"WIPO",tip:"WIPO tooltip should read: Metadata describing the technology field of the patents.",fields:this.model.getFilters("wipos")}),c=this.addTemplate({optGroup:"cited_patents",id:"cited_patents",name:"Cited Patents",tip:"Data related to patents that have been cited by the patents associated with the search criteria",fields:this.model.getFilters("cited_patents")}),h=this.addTemplate({optGroup:"application_citations",id:"application_citations",name:"Cited Appliations",tip:"Data related to patent applications that have been cited by the patents associated with the search criteria",fields:this.model.getFilters("application_citations")}),p=this.addTemplate({optGroup:"citedby_patents",id:"citedby_patents",name:"Citing Patents",tip:"Data related to patents that have cited the patents associated with the search criteria",fields:this.model.getFilters("citedby_patents")});switch(t){case"inventor":e(this.el).find("#conditions").html(this.selectCriteriaInventorTemplate({})),e(this.el).find("#patent-condition").html(n),e(this.el).find("#inventor-condition").html(r),e(this.el).find("#assignee-condition").html(i),e(this.el).find("#lawyer-condition").html(s),e(this.el).find("#cpc-condition").html(o),e(this.el).find("#nber-condition").html(u),e(this.el).find("#ipc-condition").html(a),e(this.el).find("#uspc-condition").html(f),e(this.el).find("#wipos-condition").html(l);break;case"assignee":e(this.el).find("#conditions").html(this.selectCriteriaAssigneeTemplate({})),e(this.el).find("#patent-condition").html(n),e(this.el).find("#inventor-condition").html(r),e(this.el).find("#assignee-condition").html(i),e(this.el).find("#lawyer-condition").html(s),e(this.el).find("#cpc-condition").html(o),e(this.el).find("#nber-condition").html(u),e(this.el).find("#ipc-condition").html(a),e(this.el).find("#uspc-condition").html(f),e(this.el).find("#wipos-condition").html(l);break;default:e(this.el).find("#conditions").html(this.selectCriteriaPatentTemplate({})),e(this.el).find("#patent-condition").html(n),e(this.el).find("#inventor-condition").html(r),e(this.el).find("#assignee-condition").html(i),e(this.el).find("#lawyer-condition").html(s),e(this.el).find("#cpc-condition").html(o),e(this.el).find("#nber-condition").html(u),e(this.el).find("#ipc-condition").html(a),e(this.el).find("#uspc-condition").html(f),e(this.el).find("#wipos-condition").html(l),e(this.el).find("#citedPatents-condition").html(c),e(this.el).find("#citedApplications-condition").html(h),e(this.el).find("#citingPatents-condition").html(p)}e(this.el).find('[data-toggle="popover"]').popover({trigger:"hover",placement:"top"})},toggleSearch:function(t){t=t||window.event;var n=e(t.srcElement||t.target);return this.model.get("isQuickSearch")?(e(this.el).find("#quick-search-section").hide(),e(this.el).find("#entity-section").show(),e(this.el).find("#criteria-section").show(),e(this.el).find("#back-quick-search").show(),e(this.el).find(".intro-text").hide(),e(this.el).find(".intro").removeClass("intro-centered"),this.model.set("isQuickSearch",!1)):(e(this.el).find("#entity-section").hide(),e(this.el).find("#criteria-section").hide(),e(this.el).find("#quick-search-section").show(),e(this.el).find("#back-quick-search").hide(),e(this.el).find(".intro-text").show(),e(this.el).find(".intro").addClass("intro-centered"),this.model.set("isQuickSearch",!0)),this.options.stepByStepView.displayPager(this.displayPager()),!1},keyPressQuickSearch:function(e){if(e.keyCode==13)return this.quickSearch()},keyLocation:function(n){n=n||window.event;var r=e(n.srcElement||n.target);if(n.keyCode==16||n.keyCode==9)return!0;if(r.hasClass("state")){var i=e("#add-"+r.data("id")+"-country");if(i.val().trim().toUpperCase()=="UNITED STATES")return e(r).popover("destroy"),!0;var s=e(r).attr("aria-describedby");return(t.isUndefined(s)||s==0)&&e(r).popover({content:"States data is only available for the United States.",placement:"top"}).popover("show"),!1}if(r.hasClass("city")){var i=e("#add-"+r.data("id")+"-country");if(i.val().trim().length>0)return e(r).popover("destroy"),!0;var s=e(r).attr("aria-describedby");return(t.isUndefined(s)||s==0)&&e(r).popover({content:"Specify a country first.",placement:"top"}).popover("show"),!1}},blurLocation:function(t){t=t||window.event;var n=e(t.srcElement||t.target);n.hasClass("country")?n.val().trim().length==0?(e("#add-"+n.data("id")+"-state").typeahead("val",""),e("#add-"+n.data("id")+"-city").typeahead("val","")):n.val().trim().toUpperCase()!="UNITED STATES"&&e("#add-"+n.data("id")+"-state").typeahead("val",""):e(n).popover("destroy")},quickSearch:function(){return this.model.set("isQuickSearch",!0),this.model.set("entityId","patent"),e("#next").click(),!1},submitSearch:function(){this.model.set("isQuickSearch",!1),e("#next").click()},changeCondition:function(t){t=t||window.event;var n=e(t.srcElement||t.target),r=n.hasClass("select-field-id");if(r){var i=this.model.getFilter(n.val());e(this.el).find("#add-"+n.data("id")+"-operator-container").html(this.addOperatorTemplate(i)),e(this.el).find("#add-"+n.data("id")+"-value-container").html(this.addValueTemplate(i));if(i.type=="location"){var s=e(this.el).find("#add-"+n.data("id")+'-value-container input[data-location-type="country"]'),o=e(this.el).find("#add-"+n.data("id")+'-value-container input[data-location-type="city"]'),u=e(this.el).find("#add-"+n.data("id")+'-value-container input[data-location-type="state"]'),a=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,local:["Afghanistan","Aland Islands","Albania","Algeria","American Samoa","Andorra","Angola","Anguilla","Antigua and Barbuda","Argentina","Armenia","Aruba","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bermuda","Bhutan","Bolivia","Bonaire, Sint Eustatius and Saba","Bosnia and Herzegovina","Botswana","Brazil","British Indian Ocean Territory","British Virgin Islands","Brunei","Bulgaria","Burkina Faso","Cambodia","Cameroon","Canada","Cayman Islands","Central African Republic","Chad","Chile","China","Colombia","Congo [DRC]","Congo [Republic]","Cook Islands","Costa Rica","Croatia","Cuba","Curacao","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Estonia","Ethiopia","Faroe Islands","Fiji","Finland","France","French Guiana","French Polynesia","Gabon","Gambia","Georgia","Germany","Ghana","Gibraltar","Greece","Greenland","Grenada","Guadeloupe","Guam","Guatemala","Guernsey","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hong Kong","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Isle of Man","Israel","Italy","Jamaica","Japan","Jersey","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Macau","Macedonia [FYROM]","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Martinique","Mauritania","Mauritius","Mayotte","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar [Burma]","Namibia","Nepal","Netherlands","Netherlands Antilles","New Caledonia","New Zealand","Nicaragua","Niger","Nigeria","North Korea","Northern Mariana Islands","Norway","Oman","Pakistan","Palau","Palestinian Territories","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Puerto Rico","Qatar","Romania","Russia","Saint Barthelemy","Saint Kitts and Nevis","Saint Lucia","Saint Martin","Saint Pierre and Miquelon","Saint Vincent and the Grenadines","Samoa","San Marino","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Sint Maarten","Slovakia","Slovenia","Solomon Islands","South Africa","South Korea","South Sudan","Soviet Union","Spain","Sri Lanka","Sudan","Suriname","Svalbard and Jan Mayen","Swaziland","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tokelau","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Turks and Caicos Islands","U.S. Virgin Islands","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu","Venezuela","Vietnam","Wallis and Futuna","Yemen","Yugoslavia","Zambia","Zimbabwe"],initialize:!0}),f=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,local:["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"],initialize:!0}),l=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/location.php",replace:function(e,t){return e+"?cc="+s.typeahead("val")+"&r=c"+"&c="+t}},initialize:!0});s.typeahead({hint:!0,highlight:!0,minLength:1},{name:"countries",source:a}),o.typeahead({hint:!0,highlight:!0,minLength:2},{name:"cities",source:l}),u.typeahead({hint:!0,highlight:!0,minLength:1},{name:"states",source:f})}if(i.type=="cpc"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var h=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/cpc.php",replace:function(e,t){return e+"?cc="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"cpc",source:h})}if(i.type=="uspc"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var p=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/uspc.php",replace:function(e,t){return e+"?cc="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"uspc",source:p})}if(i.type=="ipc"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var d=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/ipc.php",replace:function(e,t){return e+"?cc="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"ipc",source:d})}if(i.id=="assignee_organization"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var v=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/assignee.php",replace:function(e,t){return e+"?o="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"organization",limit:10,source:v})}if(i.id=="govint_org_name"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var m=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?n="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govName",limit:10,source:m})}if(i.id=="govint_org_level_one"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var g=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?lo="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govTopLevel",limit:10,source:g})}if(i.id=="govint_org_level_two"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var y=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?ltw="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govSecondLevel",limit:10,source:y})}if(i.id=="govint_org_level_three"){var c=e(this.el).find("#add-"+i.id+"-value");c.attr("data-provider","typeahead").attr("autocomplete","false");var b=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?lth="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govThirdLevel",limit:10,source:b})}}else{var w=n.data("id"),i=this.model.getFilter(w),c=e(this.el).find("#add-"+i.optgroup+"-value-container").find("#add-"+i.id+"-value");if(i.id=="assignee_organization")if(n.val()=="_eq"||n.val()=="_neq"){c.attr("data-provider","typeahead").attr("autocomplete","false");var v=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/assignee.php",replace:function(e,t){return e+"?o="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"organization",limit:10,source:v})}else c.typeahead("destroy");if(i.id=="govint_org_name")if(n.val()=="_eq"||n.val()=="_neq"){c.attr("data-provider","typeahead").attr("autocomplete","false");var m=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?n="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govName",limit:10,source:m})}else c.typeahead("destroy");if(i.id=="govint_org_level_one")if(n.val()=="_eq"||n.val()=="_neq"){c.attr("data-provider","typeahead").attr("autocomplete","false");var g=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?lo="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govTopLevel",limit:10,source:g})}else c.typeahead("destroy");if(i.id=="govint_org_level_two")if(n.val()=="_eq"||n.val()=="_neq"){c.attr("data-provider","typeahead").attr("autocomplete","false");var y=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?ltw="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govSecondLevel",limit:10,source:y})}else c.typeahead("destroy");if(i.id=="govint_org_level_three")if(n.val()=="_eq"||n.val()=="_neq"){c.attr("data-provider","typeahead").attr("autocomplete","false");var b=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"https://www.patentsview.org//query/gov.php",replace:function(e,t){return e+"?lth="+t}},initialize:!0});c.typeahead({hint:!0,highlight:!0,minLength:1},{name:"govThirdLevel",limit:10,source:b})}else c.typeahead("destroy")}},addCondition:function(n){n=n||window.event;var r=e(n.srcElement||n.target),i=r.closest(".condition").find("form");if(i.length==0)return;var s=i.validate({});if(i.valid()){var o=r.data("id"),u=r.data("name"),a=this.model.get("expressions"),f=e(this.el).find("#add-"+o+"-field option:selected"),l=f.val(),c=e(this.el).find("#add-"+l+"-operator option:selected"),h=this.model.getFilter(l);if(h.type=="location"){var p=e(this.el).find("#add-"+l+"-country"),d=e(this.el).find("#add-"+l+"-city"),v=e(this.el).find("#add-"+l+"-state");if(p.val().length>0){var m=this.model.getCountryCode(p.val());m.length>0&&a.push({fieldText:f.text()+" Country",field:l.replace("location","country"),operatorText:c.text(),operator:c.val(),value:m}),this.clearValue(p)}d.val().length>0&&(a.push({fieldText:f.text()+" City",field:l.replace("location","city"),operatorText:c.text(),operator:c.val(),value:d.val()}),this.clearValue(d));if(v.val().length>0){var g=this.model.getStateCode(v.val());g.length>0&&a.push({fieldText:f.text()+" State",field:l.replace("location","state"),operatorText:c.text(),operator:c.val(),value:g}),this.clearValue(v)}}else if(h.type=="cpc"){var y=e(this.el).find("#add-"+l+"-value"),b=y.val().trim(),w=b.length>0?b.substr(0,1):"",E=b.length>2?b.substr(0,3):"",S=b.length>3?b.substr(0,4):"",x=b.length>4?b:"";a.push({fieldText:"CPC Section ID",field:l.replace("class","section_id"),operatorText:c.text(),operator:c.val(),value:w.trim()}),E.length>0&&a.push({fieldText:"CPC Subsection ID",field:l.replace("class","subsection_id"),operatorText:c.text(),operator:c.val(),value:E.trim()}),S.length>0&&a.push({fieldText:"CPC Group ID",field:l.replace("class","group_id"),operatorText:c.text(),operator:c.val(),value:S.trim()}),x.length>0&&a.push({fieldText:"CPC Subgroup ID",field:l.replace("class","subgroup_id"),operatorText:c.text(),operator:c.val(),value:x.trim()}),this.clearValue(y)}else if(h.type=="uspc"){var y=e(this.el).find("#add-"+l+"-value"),b=y.val().trim().split("/"),T=b.length>0?b[0]:"",N=b.length>1?b[1]:"";T.length>0&&a.push({fieldText:"USPC Mainclass ID",field:l.replace("class","mainclass_id"),operatorText:c.text(),operator:c.val(),value:T.trim()}),N.length>0&&a.push({fieldText:"USPC Subclass ID",field:l.replace("class","subclass_id"),operatorText:c.text(),operator:c.val(),value:T.length>0?T+"/"+N:N}),this.clearValue(y)}else if(h.type=="ipc"){var y=e(this.el).find("#add-"+l+"-value"),b=y.val().trim(),C=b.length>0?b.substr(0,1):"",k=b.length>2?b.substr(1,2):"",L=b.length>3?b.substr(3,1):"",A=b.split("/"),O=b.length>4&&A.length>0?A[0].substr(4):"",M=b.length>4&&A.length>1?A[1]:"";a.push({fieldText:"IPC Section ID",field:l.replace("classes","section"),operatorText:c.text(),operator:c.val(),value:C.trim()}),k.length>0&&a.push({fieldText:"IPC Class ID",field:l.replace("classes","class"),operatorText:c.text(),operator:c.val(),value:k.trim()}),L.length>0&&a.push({fieldText:"IPC Subclass ID",field:l.replace("classes","subclass"),operatorText:c.text(),operator:c.val(),value:L.trim()}),O.length>0&&a.push({fieldText:"IPC Maingroup ID",field:l.replace("classes","main_group"),operatorText:c.text(),operator:c.val(),value:O.trim()}),M.length>0&&a.push({fieldText:"IPC Subgroup ID",field:l.replace("classes","subgroup"),operatorText:c.text(),operator:c.val(),value:M.trim()}),this.clearValue(y)}else{var y=e(this.el).find("#add-"+l+"-value");a.push({fieldText:f.text(),field:l,operatorText:c.text(),operator:c.val(),value:y.val()}),this.clearValue(y)}var D=e(this.el).find("#submitSearch-error"),P=e(this.el).find("#filters p");t.isUndefined(P)||P.remove(),t.isUndefined(D)||D.remove(),this.model.set("expressions",a),e(this.el).find("#filters").html(this.expressionsTemplate(this.model.toJSON())),s.resetForm(),this.model.set("isQuickSearch",!1),this.resetFields(o)}},resetFields:function(t){e(this.el).find("#add-"+t+"-field")[0].selectedIndex=0,e(this.el).find("#add-"+t+"-operator-container").html(this.addOperatorTemplate({id:t})),e(this.el).find("#add-"+t+"-value-container").html(this.addValueTemplate({id:t,reset:!0}))},clearAllExpressions:function(t){this.model.set("expressions",[]),e(this.el).find("#filters").html(this.expressionsTemplate(this.model.toJSON()))},clearCondition:function(t){t=t||window.event;var n=e(t.srcElement||t.target);n.remove();var r=[];e(this.el).find(".expression").each(function(t,n){var i=e(n);r.push({fieldText:i.data("fieldText"),field:i.data("field"),operatorText:i.data("operatorText"),operator:i.data("operator"),value:i.data("value")})}),this.model.set("expressions",r),e(this.el).find(".expression").length==0&&(this.model.set("expressions",[]),e(this.el).find("#filters").html(this.expressionsTemplate(this.model.toJSON())))},clearValue:function(n){if(t.isUndefined(n))return;if(e(n).is("select")){e(n).find("option").each(function(){if(this.defaultSelected)return this.selected=!0,!1});return}if(e(n).is("input")){n.val("");return}},getNextHtml:function(){return'Submit Search <i class="fa fa-caret-right" />'},getNavHtml:function(e){return""},displayPager:function(){return!this.model.get("isQuickSearch")},entityChanged:function(){this.model.set("outputIds",[]),this.model.set("quickSearch",""),this.model.set("expressions",[]),e(this.el).find("#quickSearch").val(""),e(this.el).find("#filters").html(this.expressionsTemplate(this.model.toJSON())),this.renderCategoryCriteria(),this.resetView=!0},selectEntity:function(n){n=n||window.event;var r=e(n.srcElement||n.target),i=r.val(),s=this.model.get("entityId"),o=e(this.el).find("#quickSearch").val(),u=this.model.get("expressions"),a=this;!t.isUndefined(s)&&!t.isEmpty(s)&&i!=s&&(o!=""||u.length>0)?(e(".entity-change-modal").find(".ok").on("click",function(){e(".entity-change-modal").modal("hide"),a.model.set("entityId",i),a.model.trigger("entityChanged")}),e(".entity-change-modal").find(".cancel").on("click",function(){e("#categories").find("input[type=radio][name=entity]").prop("checked",!1),e("#categories").find("input[type=radio][value="+s+"]").prop("checked",!0),e(".entity-change-modal").modal("hide")}),e(".entity-change-modal").modal("show")):(this.model.set("entityId",i),this.model.trigger("entityChanged"))}});return d});